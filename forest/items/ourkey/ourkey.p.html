<!-- template: item {title: ourkey} -->

<body>
  <img
    id="keys-target"
    class="Keys"
    src="/forest/items/ourkey/ourkey.png"
    draggable
  >

  <audio id="keys-sound">
    <!-- credits: https://www.freesoundslibrary.com/car-lock-sound-effect/ -->
    <source
      src="/forest/items/ourkey/ourkey.mp3"
      type="audio/mpeg"
    >
  </audio>
</body>

<script type="module">
  import { Distance, kMaxDistance } from "/sitemap/mapDistances.js"

  // -- constants --
  const k = {
    paths: {
      car: "/forest/55highway_to_the_cosmod"
    }
  }

  // -- props --
  /// the key sound el to play on click
  let $sound = null

  /// the key audio chain
  let audioChain = null

  // -- lifetime --
  function main() {
    d.State.foundKeys = true

    // set els
    $sound = document.getElementById("keys-sound")

    // set props
    audioChain = initAudioChain($sound)

    // bind events
    const $keys = document.getElementById("keys-target")
    $keys.addEventListener("click", onClick)
    $keys.addEventListener("dragstart", onDragStart)
  }

  /// create the audio chain
  function initAudioChain() {
    const audioCtx = new AudioContext();
    const element = $sound
    const source = audioCtx.createMediaElementSource(element);
    const gainNode = audioCtx.createGain();
    const biquadFilter = audioCtx.createBiquadFilter();

    source.connect(biquadFilter)
    biquadFilter.connect(gainNode)
    gainNode.connect(audioCtx.destination)

    return {
      biquadFilter
    }
  }

  // -- commands --
  /// play sound based on distance to car
  function playSound() {
    // get distance to car
    const maxDistance = kMaxDistance + 2 // adding the 3 extra steps to get to the car

    let distance = maxDistance
    if (d.State.foundVehicle) {
      distance = 0
    } else {
      distance = Distance(k.paths.car, d.State.location)
      // add the steps
      distance += 2 - Math.min(2, d.State.highwayStep)
    }

    // calc volume
    const normalizedDistance = distance / maxDistance;
    const nd = normalizedDistance * 6.9;
    const pdist = 1.0 / (1.0 + nd * nd)

    // set volume
    audioChain.biquadFilter.frequency.value = 10000.0 * pdist
    $sound.volume = pdist

    // play sound
    $sound.play();
  }

  // -- events --
  /// when the keys are clicked
  function onClick() {
    playSound()
  }

  /// when the image drag starts
  function onDragStart(evt) {
    // transfer dumpling id
    evt.dataTransfer.setData("a-dumpling/id", "ourkey")
  }

  // -- bootstrap --
  main()
</script>

<style>
  .Keys {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: grab;
  }

  .Keys:active {
    cursor: grabbing;
  }
</style>