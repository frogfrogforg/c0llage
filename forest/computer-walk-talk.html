<head>
    <script type="module" src="forest.js"></script>
    <link rel="stylesheet" href="/core/dumpling/dumpling.css">
    <style>
        body {
            position: relative;
            background-image: url("./images/walk-talk/bg-walk-talk.png");
            background-position: 50% 50%;
            overflow: hidden;
        }

        .icons {
            position: absolute;
            /* This is becoming a very common pattern */
            top: 2%;
            left: 3%;
            width: 100%;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            padding: 3%;
        }

        .icon {
            cursor: pointer;
            width: 4%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 9% 4% 0;
            padding: 0.5% 1% 0.3% 1%;

            font-family: monospace;
            font-size: 1vw;
            text-align: center;
            border: 0.05em rgba(0, 0, 0, 0) solid;
        }

        .icon:hover {
            background: rgba(244, 251, 255, 0.2);
            border: 0.05em rgb(244, 251, 255, 0.4) solid;
        }

        .icon-hidden {
            display: none;
        }

        .icon-opened {
            background: rgba(244, 251, 255, 0.2);
            border: 0.05em rgb(244, 251, 255, 0.4) solid;
        }

        .icon-opened img {
            filter: invert(1);
        }

        .icon img {
            image-rendering: pixelated;
            width: 90%;
            /* width: 2%; */
            /* height: 2%; */
        }

        .icon-text {
            color: white;
            margin-top: 8%;
        }

        .npc {
          position: absolute;
          height: 48px;
          image-rendering: pixelated;
          background: none;
          transform: translate(-50%, -50%);
        }

        iframe {
            border: 0;
            /* --scaleFactor: 0.6; */
            /*scale iframe content by this factor (probably breaks on older browsers)*/
            width: calc(100%/var(--scaleFactor)) !important;
            height: calc(100%/var(--scaleFactor)) !important;
            transform: scale(var(--scaleFactor));
            transform-origin: top left
        }

        #protag {
          position: absolute;
          width: 48px;
          height: 48px;
          image-rendering: pixelated;
          background: none;
          transform: translate(-50%, -50%);
        }

        #claribelle {
            position: absolute;
            left: 60px;
            top: 69px;
            transform: scale(.125);
        }

        .dumpling-container {
            position: fixed;
            top: 5vmin;
            left: 55vmin;
            width: 90vmin;
            height: 90vmin;
            z-index: 10;
            pointer-events: none;
        }
    </style>
</head>


<body style="width:100%; height:100%">

    <div class="dumpling-container">
        <a-dumpling no-back temperament="choleric" title="ending it by Karina Popp" id="out-of-bounds" w="122" h="69" min-x="-10" max-x="10" min-y="-4" max-y="10" hidden>
            <d-iframe style="--scaleFactor: 1.2;" src="https://itch.io/embed-upload/1427963?color=4E4850" allowfullscreen="" width="1280" height="740" frameborder="0"></d-iframe>
            <!-- color: 4E4850 -->
        </a-dumpling>
        <a-dumpling no-back temperament="choleric" title="rain/reign by Jude Pinto" id="every-grocery-store" w="122" h="69" min-x="-10" max-x="10" min-y="-4" max-y="10" hidden>
            <d-iframe style="--scaleFactor: 0.8;" src="https://itch.io/embed-upload/5270802?color=000000" allowfullscreen="" width="1280" height="740" frameborder="0"></d-iframe>
        </a-dumpling>

        <a-dumpling no-back temperament="choleric" title="Brock Wants To Fight by Nilson Carroll" id="brock-wants-to-fight" w="122" h="69" min-x="-10" max-x="10" min-y="-4" max-y="10" hidden>
            <d-iframe style="--scaleFactor: 0.8;" src="stolen-goods/www/" allowfullscreen="" width="1280" height="740" frameborder="0"></d-iframe>
        </a-dumpling>


        <a-dumpling layer="explanation" no-close no-back temperament="choleric" title="games where you walk around and talk to people" id="what" x="60" y="10" w="60" h="21">
            <p>
            this is a selection of short and beautiful <a target="_blank" rel=”noreferrer noopener” href="https://www.wonderville.nyc/events/love-me-play-me-2-17">games where you walk and around and talk to people </a></p>
            <p> also here's a bunch of text that is super pretentious that i am oh so excited to write</p>
                
            <p style="text-align: right;">
                - fran
            </p>
        </a-dumpling>
    </div>

    <div id=" icons" class="icons">
        <!--If you want to add more icons that open frames just copy the structure below: target is the a-dumpling's id you want the icon to open, and src is a link to the image for the icon -->
        <pc-icon target="fruitflesh" name="fruitflesh" src="./images/icons/love/fruitflesh.jpg"></pc-icon>
        <pc-icon target="rain-reign" name="rain/reign" src="./images/icons/love/rain.png"></pc-icon>
        <pc-icon target="ending-it" name="ending it" src="./images/icons/love/endingit.png"></pc-icon>
        <pc-icon target="and-i-made-sure-to-hold-your-head-sideways" name="and i made sure to hold your head sideways" src="./images/icons/love/headhold.png"></pc-icon>
        <pc-icon target="please-talk-to-me" name="please talk to me" src="./images/icons/love/pleasetalk.png"></pc-icon>
        <pc-icon target="hubol-got-emotionally-poisoned-in-iowa" name="hubol got emotionally poisoned in iowa" src="./images/icons/love/hubol.png"></pc-icon>
        <pc-icon target="best-friends" name="best friends" src="./images/icons/love/bestfriends.png"></pc-icon>

        <pc-icon target="be-happy-luv-ur-rock" name="be happy luv ur rock" src="./images/icons/love/petrock.png"></pc-icon>

        <pc-icon target="novena" name="novena" src="./images/icons/love/novena.png"></pc-icon>
        <pc-icon target="lin" name="the mountain and the ant" src="./images/icons/love/lin.png"></pc-icon>


    </div>

    
    <img id="protag" src="images/walk-talk/player-facing-down.png" />
    <img class="npc" style="top: 200px; left: 200px;"
         target="out-of-bounds"
         src="images/walk-talk/annie.png" />
    <img class="npc" style="top: 600px; left: 300px;"
         target="every-grocery-store"
         src="images/walk-talk/carl.png" />
    <img class="npc" style="top: 800px; left: 800px;"
         target="text-me"
         src="images/walk-talk/josie.png" />
    <img class="npc" style="top: 500px; left: 1100px;"
         target="brock-wants-to-fight"
         src="images/walk-talk/nilson.png" />



    <script type="module" src="/core/d-iframe.js"></script>
    <script type="module" src="/core/dumpling/a-dumpling.js"></script>
    <script type="module">
        import "/global.js"

        const tagName = 'pc-icon'
        const iconTemplate = `
        <div id="$id" class="icon">
            <img src="$src">
            <div class='icon-text'>$name</div>
        </div>
        `

        function openFrame(targetFrame, icon) {
            targetFrame.show()
        }

        function closeFrame(targetFrame, icon) {
            targetFrame.hide()
        }

        function initializeIcons() {
            document.createElement(tagName)
            const tagInstances = document.getElementsByTagName(tagName)
            while (tagInstances.length > 0) {
                let element = tagInstances[0]
                const target = element.attributes.target.value
                const src = element.attributes.src.value
                const name = element.getAttribute('name') || target
                const id = `${target}-icon`
                element.outerHTML = iconTemplate
                    .replaceAll('$id', id)
                    .replaceAll('$src', src)
                    .replaceAll('$name', name)

                const icon = document.getElementById(id);

                const targetFrame = document.getElementById(target);

                // TODO: move global flags to core?
                const conditionsString = element.getAttribute('condition') || ''
                const s = conditionsString.trim().split(' ').filter(i => i)
                let passesAllConditions = true;
                s.forEach(condition => {
                    passesAllConditions &&= d.State[condition]


                    d.State.listen(condition, () => {
                        const passesAllConditions = s
                            .reduce((aggregate, condition) => aggregate && d.State[condition], true)
                        icon.classList.toggle('icon-hidden', !passesAllConditions)
                    })
                });

                icon.classList.toggle('icon-hidden', !passesAllConditions);

                // ['hide-frame', 'show-frame'].forEach((eventName) => {
                //     targetFrame.addEventListener(eventName, (e) => {
                //         icon.classList.toggle('icon-opened', targetFrame.visible)
                //     })
                // })

                icon.onclick = () => {
                    targetFrame.toggle();
                }
            }
        }

        function initializeNPCs() {
            document.createElement(tagName)
            const tagInstances = document.getElementsByTagName(tagName)
            while (tagInstances.length > 0) {
                let element = tagInstances[0]
                const target = element.attributes.target.value
                const src = element.attributes.src.value
                const name = element.getAttribute('name') || target
                const id = `${target}-icon`
                    .replaceAll('$id', id)
                    .replaceAll('$src', src)
                    .replaceAll('$name', name)

                const icon = document.getElementById(id);

                const targetFrame = document.getElementById(target);

                // TODO: move global flags to core?
                const conditionsString = element.getAttribute('condition') || ''
                const s = conditionsString.trim().split(' ').filter(i => i)
                let passesAllConditions = true;
                s.forEach(condition => {
                    passesAllConditions &&= d.State[condition]


                    d.State.listen(condition, () => {
                        const passesAllConditions = s
                            .reduce((aggregate, condition) => aggregate && d.State[condition], true)
                        icon.classList.toggle('icon-hidden', !passesAllConditions)
                    })
                });

                icon.classList.toggle('icon-hidden', !passesAllConditions);

                // ['hide-frame', 'show-frame'].forEach((eventName) => {
                //     targetFrame.addEventListener(eventName, (e) => {
                //         icon.classList.toggle('icon-opened', targetFrame.visible)
                //     })
                // })

                icon.onclick = () => {
                    targetFrame.toggle();
                }
            }
        }

        const meElm = document.getElementById("protag");
          let me = {
            x: 0, 
            y: 0,
            dir: "down"
          };
          me.x = 300 + Math.random() * 600;
          me.y = 200 + Math.random() * 300;
          meElm.style.left = me.x + "px";
          meElm.style.top = me.y + "px";

          let meSpeed = .1;
  let meKeyVelocity = {x : 0, y: 0};
  let pressedKeys = {
      up: false,
      down: false,
      left: false,
      right: false
  }

function updatePlayer(meElm) {
    let velocity = {x : 0, y: 0};

    // grab input
    if (pressedKeys.right) {
        velocity.x += meSpeed * delta_time;
    }
    if (pressedKeys.left) {
        velocity.x -= meSpeed * delta_time;
    }
    if (pressedKeys.up) {
        velocity.y -= meSpeed * delta_time;
    }
    if (pressedKeys.down) {
        velocity.y += meSpeed * delta_time;
    }

    // move player on screen
    me.x = me.x + velocity.x;
    me.y = me.y + velocity.y

    meElm.style.left= `${me.x}px`;
    meElm.style.top= `${me.y}px`;

    // animate
    // we're standing still
    if (Math.abs(velocity.x) + Math.abs(velocity.y) < 0.01) {
      switch(me.dir) {
        case "down":
      meElm.src = "images/walk-talk/player-facing-down.png";
          break;
        case "up":
      meElm.src = "images/walk-talk/player-facing-up.png";
          break;
        case "left":
      meElm.src = "images/walk-talk/player-facing-left.png";
          break;
        case "right":
      meElm.src = "images/walk-talk/player-facing-left.png";
      meElm.style.transform = "translate(-50%, -50%) scaleX(-1)";
          break;
      }
      
    // moving more vertical than horizontal
    } else if (Math.abs(velocity.y) > Math.abs(velocity.x)) {
      if (velocity.y > 0) {
    me.dir = "down";

        if ((Date.now() % 300) > 150) {
          meElm.src = "images/walk-talk/player-walking-down.png";
        } else {
          meElm.src = "images/walk-talk/player-facing-down.png";
        }
        meElm.style.transform = "translate(-50%, -50%)";
      } else { // velocity.y < 0
    me.dir = "up";

        if ((Date.now() % 300) > 150) {
          meElm.src = "images/walk-talk/player-walking-up.png";
        } else {
          meElm.src = "images/walk-talk/player-facing-up.png";
        }
        meElm.style.transform = "translate(-50%, -50%)";
      }
    }

    // moving more horizontal than vertical
    else {

      if (velocity.x > 0) {
    me.dir = "right";

        // animate
        if ((Date.now() % 300) > 150) {
          meElm.src = "images/walk-talk/player-walking-left.png";
        } else {
          meElm.src = "images/walk-talk/player-facing-left.png";
        }
        meElm.style.transform = "translate(-50%, -50%) scaleX(-1)";
      } else { // velocity.x < 0
    me.dir = "left";

        if ((Date.now() % 300) > 150) {
          meElm.src = "images/walk-talk/player-walking-left.png";
        } else {
          meElm.src = "images/walk-talk/player-facing-left.png";
        }
        meElm.style.transform = "translate(-50%, -50%)";
      }
    }


  }


  function updateScreenPos(elm, x, y) {
    elm.style.left = x + "px";
    elm.style.top = y + "px";
  }

      let timeLastActive = Date.now();
        let last_tick = Date.now();
      let delta_time = 0;
      let tick_num = 0;
      function tick() {

        delta_time= Date.now() - last_tick;
        last_tick = Date.now();
        tick_num++;


        // exhibition mode inspired by lee
        if (Date.now() - timeLastActive > 1000*69) {
          // reset player
          timeLastActive = Date.now();
          me.x = 300 + Math.random() * 600;
          me.y = 200 + Math.random() * 300;
          meElm.style.left = me.x + "px";
          meElm.style.top = me.y + "px";
        }

        updatePlayer(meElm);


        window.requestAnimationFrame(tick);
      }

        function distSquared(x1, y1, x2, y2) {
            return Math.pow((x1 - x2), 2) + Math.pow((y1 - y2), 2);
        }

        function nearEnough(player, npc) {
          const playerRect = player.getBoundingClientRect();
          const npcRect = npc.getBoundingClientRect();
          const distsq = distSquared(playerRect.x, playerRect.y,
                                     npcRect.x, npcRect.y);

          const threshold = 8000;

          return distsq < threshold;
        }


        let npcs = [];

        function main() {

            npcs = document.getElementsByClassName("npc");
            //initializeNPCs()

                 // start input
            window.addEventListener("mousedown", e => {
              timeLastActive = Date.now();
              
              // LEFT MOUSE BUTTON
              if (e.button == 0) {
              }

              // RIGHT MOUSE BUTTON
              if (e.button == 2) {
              }

            });

            window.addEventListener("mouseup", e => {
              timeLastActive = Date.now();

              // LEFT MOUSE BUTTON
              if (e.button == 0) {
              }

              if (e.button == 2) {
              }

            });

            window.addEventListener("mousemove", e => {
              timeLastActive = Date.now();
            });

            window.addEventListener("keyup", e => {
              timeLastActive = Date.now();
            switch(e.code) {
              case "KeyS":
                  case "ArrowDown":
                pressedKeys.down = false;
                    break;
                  case "KeyW":
                  case "ArrowUp":
                pressedKeys.up = false;
                    break;
                  case "KeyA":
                  case "ArrowLeft":
                pressedKeys.left = false;
                    break;
                  case "KeyD":
                  case "ArrowRight":
                pressedKeys.right = false;
                    break;
            }
            });
            window.addEventListener("keydown", e => {
              timeLastActive = Date.now();

            switch(e.code) {
              case "KeyS":
              case "ArrowDown":
                pressedKeys.down = true;
                break;
              case "KeyW":
              case "ArrowUp":
                pressedKeys.up = true;
                break;
              case "KeyA":
              case "ArrowLeft":
                pressedKeys.left = true;
                break;
              case "KeyD":
              case "ArrowRight":
                pressedKeys.right = true;
                break;
              case "KeyE":
              case "Enter":
              case "Space":
                for (const npc of npcs) {
                  if (nearEnough(meElm, npc)) {
                    const target = npc.attributes.target.value
                    const targetFrame = document.getElementById(target);
                    targetFrame.toggle();

                    // bandaid bug where player would just keep walking
                    pressedKeys.right = false;
                    pressedKeys.down = false;
                    pressedKeys.left = false;
                    pressedKeys.up = false

                    targetFrame.focus();
                    //window.top.focus()
                  }
                }
                break;
            }

            });

            window.addEventListener("blur", e => {
              // bandaid bug where player would just keep walking
              pressedKeys.right = false;
              pressedKeys.down = false;
              pressedKeys.left = false;
              pressedKeys.up = false
              

            });



            window.requestAnimationFrame(tick);

        }

        main()





    </script>
</body>
