<!DOCTYPE HTML>
<html>

<head>
  <style>
    body {
      margin: 0;
    }

    main {
      width: 100%;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    button {
      position: absolute;
      top: 20px;
      cursor: pointer;
    }

    .Games {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .Games-frame {
      position: fixed;
      opacity: 0.9;
      border: 10px solid;
    }

    .Games-live {
      border-color: papayawhip;
    }

    .Games-capture {
      display: none;
      border-color: burlywood;
    }

    .Games.has-capture .Games-capture {
      display: block;
    }

    /* maybe bitsy needs this? */
    #touchTrigger {
      display: none;
    }
  </style>
</head>

<body>
  <main>
    <div id="games" class="Games">
      <canvas class="Games-live Games-frame" id="game"></canvas>
      <canvas class="Games-capture Games-frame" id="capture"></canvas>
    </div>

    <button onclick="Space.capture()">Capture</button>
  </main>

  <script>
    Space = (() => {
      // -- lifetime --
      function main() {
        init()
        load("./games/bitsy.html")
      }

      function init() {
        const games = document.getElementById("games")
        games.addEventListener("mousedown", onDragStart)
        games.addEventListener("mousemove", onDrag)
        games.addEventListener("mouseup", onDragEnd)
        window.addEventListener("mouseout", onDragEnd)
      }

      // -- commands --
      // load bitsy game at remote path
      async function load(path) {
        // fetch and parse the html page containing the game
        const res = await fetch(path)
        const body = await res.text()
        const html = new DOMParser().parseFromString(body, "text/html")

        // add all the scripts to a wrapper element
        const wrapper = document.createElement("object")
        wrapper.id = path

        // copy scripts into new elements, otherwise they don't execute
        const scripts = Array.from(html.scripts)
        for (const s0 of scripts) {
          const s1 = document.createElement("script")

          // copy the body of the script
          s1.text = s0.text

          // and any attributes (e.g. type)
          for (const attr of s0.attributes) {
            s1.setAttribute(attr.name, attr.value)
          }

          wrapper.appendChild(s1)
        }

        // append wrapper to document
        document.body.appendChild(wrapper)

        // call bitsy bootstrap fn
        startExportedGame()
      }

      function capture() {
        document.getElementById("games").classList.toggle("has-capture", true)

        // grab game context
        const game = document.getElementById("game")
        const w = Number.parseInt(game.getAttribute("width"))
        const h = Number.parseInt(game.getAttribute("height"))

        // extract image data from it
        const gctx = game.getContext("2d")
        const image = gctx.getImageData(0, 0, w, h)

        // resize capture canvas
        const capt = document.getElementById("capture")
        capt.setAttribute("width", w)
        capt.setAttribute("height", h)

        // copy image data into it
        const cctx = capt.getContext("2d")
        cctx.putImageData(image, 0, 0)
      }

      // -- drag --
      let el = null
      let x0 = 0.0
      let y0 = 0.0
      let mx = 0.0
      let my = 0.0

      function onDragStart(evt) {
        const target = evt.target

        if (!target.classList.contains("Games-frame")) {
          return
        }

        el = target

        // capture initial x/y position
        const f = el.getBoundingClientRect()
        x0 = f.x
        y0 = f.y

        // get mouse position (we need to calc dx/dy manually on move b/c evt.offset, the pos
        // within the element, doesn't include borders, etc.)
        mx = evt.clientX
        my = evt.clientY
      }

      function onDrag(evt) {
        if (el == null) {
          return
        }

        el.style.left = `${x0 + evt.clientX - mx}px`
        el.style.top = `${y0 + evt.clientY - my}px`
      }

      function onDragEnd() {
        el = null
      }

      // -- bootstrap --
      main()

      // -- export --
      return { capture }
    })()
  </script>
</body>

</html>
