<head>
  <script type="text/javascript">
    SaladDaze = (() => {
      // -- "imports" --
      const {
        min,
        pow,
        round: rnd,
        floor: flr,
        random: rand,
      } = Math

      // -- types --
      const Types = {
        Text: 0,
        Sprite: 1,
      }

      // -- bootstrap --
      function Start(id) {
        initAssets(document.getElementById("assets"))
        initWorld()
        initDraw(document.getElementById(id))
        initLoop()
      }

      // -- loop --
      const kFramerate = 30
      const kFrameInterval = 1000.0 / kFramerate
      let mFrame = 1

      function initLoop() {
        setInterval(loop, kFrameInterval)
      }

      // -- l/commands
      function loop() {
        update()
        draw()
        mFrame += 1
      }

      // -- assets --
      let mAssets

      function initAssets(el) {
        // aggregate assets
        mAssets = {}
        for (const asset of el.children) {
          mAssets[asset.id] = asset
        }
      }

      // -- world --
      const kSize = { x: 512, y: 512 }
      const kNumTeeth = 16

      let mObjects

      function initWorld() {
        mObjects = []

        addObject(makeTitle())
        for (let i = 0; i < kNumTeeth; i++) {
          addObject(makeTooth(i))
        }
      }

      // -- w/commands
      function update() {
        for (const obj of mObjects) {
          if (obj.update != null) {
            obj.update()
          }
        }
      }

      function addObject(obj) {
        mObjects.push(obj)
      }

      // -- w/factories
      function makeTitle() {
        const text = "FREESALADFREESALAD"
        const size = 240.0

        // measure height to loop text
        const h = text.length * size
        const h2 = h / 2.0

        return makeText(text, {
          size,
          down: true,
          x: (kSize.x - 170.0) / 2,
          y: (kSize.y + size),
          update() {
            // animate text up
            this.y -= 0.8 * kFrameInterval

            // loop text once we're below the repeat
            if (this.y < -h2) {
              this.y += h2
            }
          }
        })
      }

      function makeText(text, props) {
        return {
          type: Types.Text,
          text: text,
          x: 0.0,
          y: 0.0,
          size: 0.0,
          down: false,
          ...props
        }
      }

      function makeTooth(i) {
        const len = flr(kNumTeeth / 2)
        const row = flr(i / len)
        const col = i % len

        const s = makeSprite("tooth", {
          a: (row + 1) * Math.PI
        })

        const w = s.w
        const h = s.h
        const ox = smp.sym(2.0)
        const oy = smp.sym(3.0)

        function animX() {
          return 80.0 + col * (w - 5.0) + ox
        }

        function animY() {
          const curve = crv.quad(mFrame % 30, 30)

          if (row == 0) {
            scale = 25.0 + curve * 5.0
          } else {
            scale = 10.0 + curve * 50.0
          }

          return 10.0 + row * h + crv.quad(col, len, scale) + oy
        }

        return {
          ...s,
          update() {
            this.x = animX()
            this.y = animY()

            if (mFrame % 10 == 0) {
              this.tx = smp.sym(0.5)
              this.ty = smp.sym(0.5)
            }
          }
        }
      }

      function makeSprite(name, props) {
        const asset = mAssets[name]

        return {
          type: Types.Sprite,
          name: name,
          x: 0.0,
          y: 0.0,
          w: asset.width,
          h: asset.height,
          a: 0.0,
          tx: 0.0,
          ty: 0.0,
          ...props
        }
      }

      function vzero() {
        return { x: 0, y: 0 }
      }

      // -- draw --
      let mCanvas
      let mCtx

      function initDraw(el) {
        // configure canvas
        mCanvas = el
        mCanvas.setAttribute("width", kSize.x)
        mCanvas.setAttribute("height", kSize.y)

        // grab ref to drawing context
        mCtx = mCanvas.getContext("2d")
      }

      // -- d/commands
      function draw() {
        drawBackground();

        for (const obj of mObjects) {
          switch (obj.type) {
            case Types.Text:
              drawText(obj); break
            case Types.Sprite:
              drawSprite(obj); break
          }
        }
      }

      function drawBackground() {
        mCtx.fillStyle = "papayawhip"
        mCtx.fillRect(0.0, 0.0, kSize.x, kSize.y);
      }

      function drawText(t) {
        mCtx.fillStyle = "black"
        mCtx.font = `${t.size}px serif`

        let x = t.x
        let y = t.y + t.size

        if (!t.down) {
          mCtx.fillText(t.text, x, y)
        } else {
          for (const char of t.text) {
            mCtx.fillText(char, x, y)
            y += t.size
          }
        }
      }

      function drawSprite(s) {
        const asset = mAssets[s.name]
        const x = s.x + s.tx
        const y = s.y + s.ty

        if (s.a == 0.0) {
          mCtx.drawImage(asset, x, y, s.w, s.h)
        } else {
          const w2 = s.w / 2
          const h2 = s.h / 2
          const cx = x + w2
          const cy = y + h2

          mCtx.translate(cx, cy);
          mCtx.rotate(s.a);
          mCtx.drawImage(asset, -w2, -h2, s.w, s.h);
          mCtx.rotate(-s.a);
          mCtx.translate(-cx, -cy);
        }
      }

      // -- helpers --
      function nrm(value, len, scale = 1.0) {
        return min(value / (len - 1), 1.0) * scale
      }

      const smp = {
        sym(scale = 1.0) {
          return 2.0 * (rand() - 0.5) * scale
        }
      }

      const crv = {
        quad(val, len, scale = 1.0) {
          const l2 = len / 2
          const offset = len % 2 == 0 ? 0.5 : 0
          return (1 - pow((val - l2 + offset) / l2, 2.0)) * scale
        }
      }

      // -- "exports" --
      return Start
    })()
  </script>
</head>

<body onload='SaladDaze("game")'>
  <canvas id="game"></canvas>

  <!-- this probably won't work when loaded externally -->
  <object id="assets" style="display: none">
    <img id="tooth" src="./tooth.png">
  </object>
</body>
