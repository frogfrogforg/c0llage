<head>
  <script type="text/javascript">
    SaladDaze = (() => {
      const Types = {
        Text: 0,
        Sprite: 1,
      }

      // -- bootstrap --
      function Start(id) {
        initAssets(document.getElementById("assets"))
        initWorld()
        initDraw(document.getElementById(id))
        initLoop()
      }

      // -- loop --
      const kFramerate = 30
      const kFrameInterval = 1000.0 / kFramerate

      function initLoop() {
        setInterval(loop, kFrameInterval)
      }

      // -- l/commands
      function loop() {
        update()
        draw()
      }

      // -- assets --
      let mAssets

      function initAssets(el) {
        // aggregate assets
        mAssets = {}
        for (const asset of el.children) {
          mAssets[asset.id] = asset
        }
      }

      // -- world --
      const kSize = { x: 512, y: 512 }
      const kNumTeeth = 16

      let mObjects

      function initWorld() {
        mObjects = []

        addObject(makeTitle())

        for (let i = 0; i < kNumTeeth; i++) {
          addObject(makeTooth(i))
        }
      }

      // -- w/commands
      function update() {
        for (const obj of mObjects) {
          if (obj.update != null) {
            obj.update()
          }
        }
      }

      function addObject(obj) {
        mObjects.push(obj)
      }

      // -- w/factories
      function makeTitle() {
        const size = 240.0

        return makeText("FREESALAD", {
          size,
          down: true,
          x: (kSize.x - 170.0) / 2,
          y: (kSize.y + size),
          update() {
            this.y -= 0.8 * kFrameInterval
          }
        })
      }

      function makeText(text, props) {
        return {
          type: Types.Text,
          text: text,
          x: 0.0,
          y: 0.0,
          size: 0.0,
          down: false,
          ...props
        }
      }

      function makeTooth(i) {
        const len = Math.floor(kNumTeeth / 2)
        const row = Math.floor(i / len)
        const col = i % len

        const sprite = makeSprite("tooth", {
          a: (row + 1) * Math.PI
        })

        return {
          ...sprite,
          x: 10.0 + col * (sprite.w - 5.0),
          y: 10.0 + row * (sprite.h),
        }
      }

      function makeSprite(name, props) {
        const asset = mAssets[name]

        return {
          type: Types.Sprite,
          name: name,
          x: 0.0,
          y: 0.0,
          w: asset.width,
          h: asset.height,
          a: 0.0,
          ...props
        }
      }

      function vzero() {
        return { x: 0, y: 0 }
      }

      // -- draw --
      let mCanvas
      let mCtx

      function initDraw(el) {
        // configure canvas
        mCanvas = el
        mCanvas.setAttribute("width", kSize.x)
        mCanvas.setAttribute("height", kSize.y)

        // grab ref to drawing context
        mCtx = mCanvas.getContext("2d")
      }

      // -- d/commands
      function draw() {
        mCtx.clearRect(0.0, 0.0, kSize.x, kSize.y);

        for (const obj of mObjects) {
          switch (obj.type) {
            case Types.Text:
              drawText(obj); break
            case Types.Sprite:
              drawSprite(obj); break
          }
        }
      }

      function drawText(t) {
        mCtx.font = `${t.size}px serif`

        let x = t.x
        let y = t.y + t.size

        if (!t.down) {
          mCtx.fillText(t.text, x, y)
        } else {
          for (const char of t.text) {
            mCtx.fillText(char, x, y)
            y += t.size
          }
        }
      }

      function drawSprite(s) {
        const asset = mAssets[s.name]

        if (s.a == 0.0) {
          mCtx.drawImage(asset, s.x, s.y, s.w, s.h)
        } else {
          const w2 = s.w / 2
          const h2 = s.h / 2
          const cx = s.x + w2
          const cy = s.y + h2

          mCtx.translate(cx, cy);
          mCtx.rotate(s.a);
          mCtx.drawImage(asset, -w2, -h2, s.w, s.h);
          mCtx.rotate(-s.a);
          mCtx.translate(-cx, -cy);
        }
      }

      // -- exports --
      return Start
    })()
  </script>
</head>

<body onload='SaladDaze("game")'>
  <canvas id="game"></canvas>
  <!-- this probably won't work when loaded externally -->
  <object id="assets" style="display: none">
    <img id="tooth" src="./tooth.png">
  </object>
</body>
