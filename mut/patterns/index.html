<html>

<head>
  <script src="../../lib/opentype.min.js"></script>
  <script src="../../lib/seedrandom.min.js"></script>
  <style>
    @font-face {
      font-family: "TesseraeEx";
      src: url(./Tesserae-4x4Extended.otf) format("truetype");
    }

    @font-face {
      font-family: "Hussar";
      src: url(./HussarBold-7mRE.otf) format("truetype");
    }

    html {
      width: 100%;
      height: 100%;
    }

    body {
      width: 100%;
      height: 100%;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3ffff;
    }

    .bgcanvas {
      margin: 3em;
      border-width: 1em;
      border-style: solid;
      border-color: #220000;
      /* position: fixed; */
      /* width: 100%; */
      /* height: 100%; */
      /* top: 0; */
      /* left: 0; */
    }
  </style>
</head>

<body>
  <div>
    <input type='button' value='randomize' onclick="randomize()">
    <form action="javascript:void(0)" onsubmit="setglyphs()">
      <label for="glyphs">Select your glyphs (space separated, 1 to 965):</label>
      <input type="text" id="glyphs" name="glyphs">
      <input type="submit" value="generate">
    </form>
    <canvas name='test' class="bgcanvas" id='pattern' width='1024' height='512'></canvas>
    <div>
      <input type='button' value='download' onclick="download()">
    </div>
  </div>
</body>
<script>
  // cool ones
  // 332 334 
  // 385 325 385 
  // 701 702 
  // 519 726
  // 636 632 vertical
  // 382 horizontal

  const tileSize = 32

  const canvas = document.getElementById('pattern')
  const ctx = canvas.getContext('2d');
  const width = canvas.width / tileSize
  const height = canvas.height / tileSize


  let loadedFont = null

  let bgColor = '#eeeeee'
  let color = '#89abdc'
  let seed = 'hello'

  const yOffsets = new Array(width).fill(0)
  const ySpeeds = new Array(width).fill(0)

  const xOffsets = new Array(height).fill(0)
  const xSpeeds = new Array(height).fill(0)

  for (let i = 0; i < width; i++) {
    //ySpeeds[i] = (0.01 * Math.sin(i * (2 * Math.PI / width)))
    ySpeeds[i] = 0.005 - (0.01 * Math.sin(i * (1 * Math.PI / width)))
    //ySpeeds[i] = 0.02
  }
  for (let i = 0; i < height; i++) {
    //xSpeeds[i] = ((i % 2) - 0.5) * 0.005
    //xSpeeds[i] = ((Math.random()) - 0.5) * 0.003//590 2
    //xSpeeds[i] = (0.002 * Math.sin(0.1 + i * (8 * Math.PI / width)))
  }


  const queryString = window.location.search;
  const urlParams = new URLSearchParams(queryString);
  const urlGlyphs = urlParams.get('glyphs')

  let possibilities


  function randomize() {
    seed = Math.random()
    possibilities = (new Array(Math.floor(Math.random() * 3 + 1))).fill(0)
      .map(_ => Math.floor(Math.random() * loadedFont.glyphs.length) + 1)
    document.getElementById('glyphs').value = possibilities.join(' ')
    setUrlParams()
  }

  function setUrlParams() {
    var newurl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?glyphs=${possibilities.join('+')}`
    window.history.pushState({ path: newurl }, '', newurl);
  }

  function setglyphs() {
    possibilities = document
      .getElementById('glyphs')
      .value
      .trim()
      .split(' ')
      .filter(s => s)
      .map(s => Number(s))
      .filter(s => (s > 0) && (s <= loadedFont.glyphs.length))
    console.log(possibilities)
    console.log(possibilities)

    createPattern(loadedFont)
    setUrlParams()
    document.getElementById('glyphs').value = possibilities.join(' ')
  }

  function rnd(arr) {
    return arr[Math.floor(Math.random() * arr.length)]
  }

  function getGlyph(x, y, t) {
    return rnd(possibilities)
  }

  function getRotation(x, y, t) {
    //return Math.floor(Math.random() * 4)

    //return x % 8 < 4 ? rnd([1, 3]) : rnd([0, 2])

    return rnd([1, 3]) // horizontal
    //return rnd([0, 2]) // vertical
  }

  function getScale(x, y, t) {
    return [1, -1]
    return [1, rnd([-1, 1])]
  }

  function download() {
    var link = document.createElement('a');
    link.download = possibilities.join('-') + '.png'
    link.href = canvas.toDataURL()
    link.click();
  }

  //function animationLoop(minSpeed, maxSpeed, minDuration, maxDuration) {
  //}

  let t = 0
  function createPattern(font, seed) {
    t++
    console.log('aaaaa')
    Math.seedrandom(seed)
    // Now let's display it on a canvas with id "canvas"

    //canvas.width = window.width
    //canvas.height = window.height

    ctx.fillStyle = bgColor
    ctx.fillRect(0, 0, canvas.width, canvas.height)

    // Construct a Path object containing the letter shapes of the given text.
    // The other parameters are x, y and fontSize.
    // Note that y is the position of the baseline.

    //const path = font.getPath('abcdefghij', 10, 50, 32);
    let g = 0
    //console.log(xOffsets, yOffsets)

    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const n = getGlyph(x, y, t)
        const glyph = font.glyphs.get(n - 1)

        const rot = getRotation(x, y, t)
        const angle = 90 * rot * Math.PI / 180

        xOffsets[y] = (xOffsets[y] + xSpeeds[y])
        if (xOffsets[y] > width) {
          xOffsets[y] -= width
        }
        if (xOffsets[y] <= -width) {
          xOffsets[y] += width
        }
        xOffset = xOffsets[y]

        yOffsets[x] = (yOffsets[x] + ySpeeds[x])
        yOffset = yOffsets[x]
        if (yOffsets[x] > height) {
          yOffsets[x] -= height
        }
        if (yOffsets[x] <= -height) {
          yOffsets[x] += height
        }

        //console.log(x, y, xOffset, yOffset)

        //const rot = x % 4
        //const rot = 0

        // draw
        const scale = getScale(x, y, t)
        for (let i = -1; i < 2; i++) {
          for (let j = -1; j < 2; j++) {
            //const color = `#${x % 2 == 0 ? 'ff' : '00'}00${Math.floor((x-1) / 2) == 0 ? 'ff' : '00'}`
            ctx.resetTransform()
            //ctx.translate(canvas.width / 2, canvas.height / 2)
            //ctx.scale(0.3, 0.3)
            ctx.translate((x + xOffset + width * i + 0.5) * tileSize, (y + yOffset + height * j + 0.5) * tileSize)
            ctx.rotate(angle)

            // horizontal and vertical flip
            //ctx.scale(rnd([-1, 1]), rnd([-1, 1]))
            ctx.scale(...scale)

            const x1 = -tileSize / 2
            const y1 = tileSize / 2
            ctx.translate(x1, y1)

            const path = glyph.getPath(0, 0, tileSize / 0.8)
            path.fill = color
            path.stroke = color
            path.draw(ctx)
            ctx.resetTransform()
          }
        }
      }
    }
  }

  function animate() {
    createPattern(loadedFont, seed)
    window.requestAnimationFrame(animate)
  }

  opentype.load('./Tesserae-4x4Extended.otf', function (err, font) {
    if (err) {
      alert('Font could not be loaded: ' + err);
    } else {
      loadedFont = font
      if (urlGlyphs != null) {
        possibilities = urlGlyphs
          .trim()
          .split(' ')
          .filter(s => s)
          .map(s => Number(s))
          .filter(s => (s > 0) && (s <= loadedFont.glyphs.length))
      } else {
        randomize()
      }
      setUrlParams()
      document.getElementById('glyphs').value = possibilities.join(' ')
      //createPattern(font);
      const canvas = document.getElementById('pattern')
      const ctx = canvas.getContext('2d');
      canvas.onpointerdown = () => {
        seed = Math.random()
      }
      animate()
    }
  });
</script>

</html>